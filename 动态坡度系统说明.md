# ⛷️ 动态坡度系统说明 (1-90度)

## 🎯 核心改进

### 1. 跳跃系统修复 ✅
**问题**：有时点击鼠标左键无法跳跃
**原因**：之前的代码要求 `isGrounded === true` 才能跳跃，但在某些情况下这个状态更新不及时

**解决方案**：
```javascript
// 修改前
jump() {
    if (this.isGrounded) {
        this.velocityY = CONFIG.jumpForce;
        this.isGrounded = false;
    }
}

// 修改后
jump() {
    // 只要不是在快速上升中就可以跳
    if (this.velocityY > -5) {
        this.velocityY = CONFIG.jumpForce;
        this.isGrounded = false;
    }
}
```

**效果**：
- ✅ 跳跃响应更灵敏
- ✅ 允许在下落过程中二段跳
- ✅ 防止在快速上升时重复跳跃

---

### 2. 光滑坡面实现 🏔️

#### A. 密集采样点
```javascript
// 修改前：每30像素一个点
for (let i = 0; i <= width; i += 30) { ... }

// 修改后：每10像素一个点（3倍密度）
for (let i = 0; i <= width; i += 10) { ... }
```

#### B. 贝塞尔曲线渲染
```javascript
// 使用二次贝塞尔曲线连接点
for (let i = 1; i < this.points.length - 1; i++) {
    const xc = (this.points[i].x + this.points[i + 1].x) / 2;
    const yc = (this.points[i].y + this.points[i + 1].y) / 2;
    ctx.quadraticCurveTo(this.points[i].x, this.points[i].y, xc, yc);
}
```

#### C. 平滑坡度过渡
```javascript
// 平滑过渡到新坡度（避免突变）
const targetAngle = slopeAngle;
const currentAngle = lastPoint.angle || 20;
const smoothAngle = currentAngle + (targetAngle - currentAngle) * 0.05;
```

**效果对比**：
```
修改前（折线）:    修改后（曲线）:
    /\                 ╱╲
   /  \               ╱  ╲
  /    \             ╱    ╲
 /      \           ╱      ╲
```

---

### 3. 动态坡度系统 (1-90度) 📐

#### 坡度角度范围
- **最小坡度**：5度（缓坡）
- **最大坡度**：90度（垂直）
- **变化频率**：每300像素改变一次

#### 实现原理

##### A. 角度到斜率转换
```javascript
// 坡度角度（度）
const slopeAngle = 5 + Math.random() * 85; // 5-90度

// 转换为弧度
const slopeRad = (slopeAngle * Math.PI) / 180;

// 计算斜率（tan值）
const slope = Math.tan(slopeRad);

// 计算Y坐标增量
const deltaY = distance * slope;
```

##### B. 坡度对照表

| 角度 | 斜率(tan) | 描述 | 滑雪难度 |
|------|-----------|------|----------|
| 5° | 0.087 | 极缓坡 | ⭐ 初学者 |
| 15° | 0.268 | 缓坡 | ⭐⭐ 初级 |
| 30° | 0.577 | 中坡 | ⭐⭐⭐ 中级 |
| 45° | 1.000 | 陡坡 | ⭐⭐⭐⭐ 高级 |
| 60° | 1.732 | 很陡 | ⭐⭐⭐⭐⭐ 专家 |
| 75° | 3.732 | 极陡 | ⭐⭐⭐⭐⭐⭐ 极限 |
| 90° | ∞ | 垂直 | 💀 自由落体 |

##### C. 坡度变化逻辑
```javascript
// 每隔300像素改变坡度
if (Math.floor(newX) % 300 < 10) {
    // 生成新的随机坡度：5-90度
    slopeAngle = 5 + Math.random() * 85;
}

// 平滑过渡（避免突变）
const smoothAngle = currentAngle + (targetAngle - currentAngle) * 0.05;
```

#### 视觉效果

```
距离 0-300px:     缓坡 (15°)
     ╲
      ╲
       ╲

距离 300-600px:   陡坡 (60°)
        │
        │
        │

距离 600-900px:   中坡 (30°)
         ╲
          ╲
           ╲

距离 900-1200px:  极陡 (80°)
           │
           │
           │
```

---

### 4. 小屋尺寸增大 🏠

```javascript
// 修改前
this.width = type === 'rock' ? 60 : 100;
this.height = type === 'rock' ? 50 : 80;

// 修改后
this.width = type === 'rock' ? 60 : 150;  // 小屋宽度 +50%
this.height = type === 'rock' ? 50 : 120; // 小屋高度 +50%
```

#### 小屋交互特性

1. **可穿过**：熊猫可以直接穿过小屋
2. **可跳跃**：可以跳过小屋顶部
3. **碰撞减速**：撞到小屋会减速但不会停止

**小屋尺寸对比**：
```
修改前:          修改后:
  ┌──┐            ┌────┐
  │  │            │    │
  │  │            │    │
  └──┘            │    │
                  └────┘
 100x80          150x120
```

---

## 🎮 游戏体验提升

### 坡度变化带来的挑战

#### 1. 缓坡 (5-20度)
- 速度较慢
- 容易控制
- 适合准备跳跃

#### 2. 中坡 (20-45度)
- 速度适中
- 需要注意障碍物
- 最常见的坡度

#### 3. 陡坡 (45-70度)
- 速度很快
- 难以控制
- 需要提前判断

#### 4. 极陡坡 (70-90度)
- 接近自由落体
- 极难控制
- 刺激感最强

### 策略建议

1. **缓坡时**：
   - 🎯 准备跳跃
   - 🎯 调整位置
   - 🎯 规划路线

2. **陡坡时**：
   - ⚠️ 保持冷静
   - ⚠️ 及时跳跃避障
   - ⚠️ 利用翻转加速

3. **极陡坡时**：
   - 🚨 快速反应
   - 🚨 连续跳跃
   - 🚨 避免碰撞

---

## 📊 技术参数

### 地形生成参数

| 参数 | 值 | 说明 |
|------|-----|------|
| 采样间隔 | 10px | 点之间的距离 |
| 坡度范围 | 5-90° | 角度范围 |
| 变化频率 | 300px | 坡度改变间隔 |
| 平滑系数 | 0.05 | 坡度过渡速度 |
| 基准高度 | 200px | 起始Y坐标 |

### 跳跃参数

| 参数 | 值 | 说明 |
|------|-----|------|
| 跳跃力 | -18 | 初始向上速度 |
| 重力 | 0.8 | 下落加速度 |
| 跳跃条件 | velocityY > -5 | 允许跳跃的速度范围 |

### 小屋参数

| 参数 | 值 | 说明 |
|------|-----|------|
| 宽度 | 150px | 小屋宽度 |
| 高度 | 120px | 小屋高度 |
| 可穿过 | ✅ | 可以直接穿过 |
| 可跳跃 | ✅ | 可以跳过顶部 |

---

## 🔧 调试和调优

### 查看当前坡度
```javascript
// 在控制台输出当前坡度
console.log('Current Slope Angle:', terrain.points[50].angle + '°');
```

### 调整坡度范围
```javascript
// 更温和的坡度（5-45度）
slopeAngle = 5 + Math.random() * 40;

// 更极限的坡度（30-90度）
slopeAngle = 30 + Math.random() * 60;
```

### 调整变化频率
```javascript
// 更频繁变化（每200px）
if (Math.floor(newX) % 200 < 10) { ... }

// 更少变化（每500px）
if (Math.floor(newX) % 500 < 10) { ... }
```

### 调整平滑度
```javascript
// 更快过渡（不够平滑）
const smoothAngle = currentAngle + (targetAngle - currentAngle) * 0.1;

// 更慢过渡（更平滑）
const smoothAngle = currentAngle + (targetAngle - currentAngle) * 0.02;
```

---

## 🎯 效果总结

### ✅ 已实现功能

1. **跳跃修复**
   - ✅ 响应更灵敏
   - ✅ 不再出现无法跳跃的情况
   - ✅ 支持空中二段跳

2. **光滑坡面**
   - ✅ 3倍密集的采样点
   - ✅ 贝塞尔曲线渲染
   - ✅ 平滑的坡度过渡
   - ✅ 视觉效果流畅

3. **动态坡度 (1-90度)**
   - ✅ 坡度范围：5-90度
   - ✅ 每300px变化一次
   - ✅ 平滑过渡不突变
   - ✅ 真实的滑雪体验

4. **小屋增大**
   - ✅ 尺寸增加50%
   - ✅ 更容易看见
   - ✅ 可穿过可跳跃
   - ✅ 更有挑战性

### 🎮 游戏体验

- **更流畅**：光滑的坡面，无折线感
- **更刺激**：1-90度的坡度变化
- **更真实**：模拟真实滑雪场的坡度
- **更灵活**：跳跃响应更快
- **更挑战**：更大的障碍物

---

**版本**：4.0 - 动态坡度系统
**更新日期**：2024
**状态**：✅ 已完成并测试
