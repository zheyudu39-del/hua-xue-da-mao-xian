# 背景循环显示说明

## 功能概述
确保雪松和雪山在整个游戏进程中始终可见，形成无限循环的背景效果。

## 实现方案

### 1. 雪山背景 🏔️

#### 固定背景
```javascript
drawMountains() {
    // 超远景山脉
    // 远景山脉
    // 中景山脉
    // 近景山脉
}
```

**特点**：
- 雪山是固定绘制的
- 使用sin函数产生微小波动
- 波动基于distance，产生视差效果
- **始终可见，不会消失**

#### 视差效果
```javascript
const y = this.canvas.height * 0.05 + Math.sin(i * 0.5 - this.distance * 0.0001) * 120;
```

**说明**：
- 基于distance产生微小波动
- 不同层次移动速度不同
- 创造深度感
- 但始终在屏幕上

### 2. 雪松树 🌲

#### 修改前（问题）❌
```javascript
// 树移出屏幕后重新生成
if (tree.x - tree.offsetX < -tree.size) {
    tree.offsetX = -this.canvas.width - Math.random() * 500;
    tree.y = this.canvas.height * 0.4 + Math.random() * this.canvas.height * 0.3;
    tree.size = 40 + Math.random() * 60;
}
```

**问题**：
- 树移出左侧后，重置到右侧很远的地方
- 可能出现长时间看不到树的情况
- 树的位置和大小会随机变化
- 不够连续

#### 修改后（循环）✅
```javascript
// 树移出屏幕左侧后，从右侧重新出现（循环滚动）
if (tree.x - tree.offsetX < -tree.size) {
    // 重置到屏幕右侧，形成无限循环
    tree.offsetX -= this.canvas.width * 2.5;
}
```

**优势**：
- 树移出左侧后，立即从右侧出现
- 保持树的原始大小和位置
- 形成无缝循环
- **始终可见**

## 技术细节

### 循环滚动原理

#### 初始状态
```
屏幕范围：0 - 3840px

树的位置：
树1: x=500,  offsetX=0    → 显示位置=500
树2: x=1500, offsetX=0    → 显示位置=1500
树3: x=2500, offsetX=0    → 显示位置=2500
```

#### 移动过程
```
速度：8px/帧

帧1: offsetX += 8
树1: x=500, offsetX=8     → 显示位置=492
树2: x=1500, offsetX=8    → 显示位置=1492
树3: x=2500, offsetX=8    → 显示位置=2492

帧2: offsetX += 8
树1: x=500, offsetX=16    → 显示位置=484
...
```

#### 循环重置
```
当树1移出左侧：
x=500, offsetX=600 → 显示位置=-100（移出屏幕）

触发重置：
offsetX -= 3840 * 2.5 = -9600
新offsetX = 600 - 9600 = -9000
显示位置 = 500 - (-9000) = 9500（屏幕右侧）

树从右侧重新出现！
```

### 为什么是2.5倍？

```javascript
tree.offsetX -= this.canvas.width * 2.5;
```

**计算**：
- canvas.width = 3840px
- 2.5倍 = 9600px
- 初始树的分布范围：0 - 7680px（2倍canvas宽度）
- 重置距离9600px > 7680px
- 确保树从右侧出现

### 视差速度

```javascript
const moveSpeed = tree.layer === 'far' ? this.speed * 0.3 : this.speed * 0.6;
```

**分层**：
- **远景树**：移动速度 × 0.3（慢）
- **近景树**：移动速度 × 0.6（快）
- 创造深度感

## 效果对比

### 修改前 ❌
```
时间轴：
0s   树可见
10s  树可见
20s  树移出左侧
30s  无树（等待重新生成）
40s  无树
50s  树从右侧出现
60s  树可见
```

**问题**：
- 有20-30秒看不到树
- 背景单调
- 缺乏连续性

### 修改后 ✅
```
时间轴：
0s   树可见
10s  树可见
20s  树移出左侧，立即从右侧出现
30s  树可见
40s  树可见
50s  树移出左侧，立即从右侧出现
60s  树可见
```

**优势**：
- 始终有树可见
- 背景丰富
- 无缝循环

## 背景元素总览

### 始终可见的元素

| 元素 | 类型 | 可见性 | 循环方式 |
|------|------|--------|---------|
| **雪山** | 固定背景 | ✅ 始终可见 | 视差波动 |
| **雪松** | 滚动对象 | ✅ 始终可见 | 循环滚动 |
| **飘雪** | 粒子效果 | ✅ 始终可见 | 上下循环 |
| **地形** | 滚动地面 | ✅ 始终可见 | 无限生成 |

### 视差层次

```
从远到近：
1. 超远景雪山（移动最慢，几乎静止）
2. 远景雪山
3. 中景雪山
4. 近景雪山
5. 远景雪松（移动速度 × 0.3）
6. 近景雪松（移动速度 × 0.6）
7. 地形（移动速度 × 1.0）
```

## 代码位置

### 雪松循环（game.js 第365-375行）
```javascript
// Update trees（树木循环滚动，始终可见）
this.trees.forEach(tree => {
    const moveSpeed = tree.layer === 'far' ? this.speed * 0.3 : this.speed * 0.6;
    tree.offsetX += moveSpeed;
    
    // 树移出屏幕左侧后，从右侧重新出现（循环滚动）
    if (tree.x - tree.offsetX < -tree.size) {
        // 重置到屏幕右侧，形成无限循环
        tree.offsetX -= this.canvas.width * 2.5;
    }
});
```

### 雪山绘制（game.js 第426-537行）
```javascript
drawMountains() {
    // 超远景山脉
    // 远景山脉
    // 中景山脉
    // 近景山脉
    // 每层都有主体和雪顶
}
```

### 雪松初始化（game.js 第100-111行）
```javascript
initTrees() {
    // 初始化雪松树（背景装饰）
    for (let i = 0; i < 15; i++) {
        this.trees.push({
            x: Math.random() * this.canvas.width * 2,
            y: this.canvas.height * 0.4 + Math.random() * this.canvas.height * 0.3,
            size: 40 + Math.random() * 60,
            layer: Math.random() > 0.5 ? 'far' : 'near',
            offsetX: 0
        });
    }
}
```

## 性能优化

### 树的数量
```javascript
for (let i = 0; i < 15; i++) {
    // 15棵树
}
```

**平衡**：
- 15棵树足够丰富
- 不会过度消耗性能
- 循环滚动保证始终可见

### 更新频率
```javascript
this.trees.forEach(tree => {
    // 每帧更新一次
});
```

**优化**：
- 简单的位置计算
- 无复杂逻辑
- 性能开销小

## 视觉效果

### 无限滚动
```
←←←←←←←←←←←←←←←←←←←←←←←
🌲  🌲    🌲  🌲    🌲  🌲
←←←←←←←←←←←←←←←←←←←←←←←

树从左侧移出，从右侧进入
形成无限循环
```

### 深度层次
```
远景（慢）：  🌲      🌲      🌲
近景（快）：🌲  🌲  🌲  🌲  🌲
地形（最快）：═══════════════
```

## 总结

### ✅ 实现效果
- 🏔️ **雪山**：固定背景，始终可见
- 🌲 **雪松**：循环滚动，始终可见
- ❄️ **飘雪**：粒子循环，始终可见
- 🎨 **视差效果**：多层深度，丰富画面

### 🎯 技术特点
- **无缝循环**：树移出左侧，立即从右侧出现
- **视差滚动**：不同层次不同速度
- **性能优化**：简单高效的更新逻辑
- **始终可见**：整个游戏过程都有背景

### 📊 数据指标
- 雪山层次：4层
- 雪松数量：15棵
- 循环距离：9600px
- 视差速度：0.3x - 0.6x

---

**版本**：背景循环显示 v1.0
**更新日期**：2025-11-21
**状态**：✅ 已实现

刷新浏览器，雪松和雪山将在整个游戏中始终可见！🏔️🌲✨
